<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Mario Adventure</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #5C94FC, #98FB98);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
        }
        
        .game-container {
            position: relative;
        }
        
        canvas {
            border: 4px solid #333;
            background: linear-gradient(to bottom, #5C94FC, #98FB98);
            display: block;
        }
        
        .ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 18px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 10;
        }
        
        .level-info {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 18px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 10;
        }
        
        .controls {
            position: absolute;
            bottom: -80px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-size: 14px;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .boss-health {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            display: none;
        }

        .health-bar {
            width: 200px;
            height: 20px;
            background: #333;
            border: 2px solid #fff;
            margin-top: 5px;
            position: relative;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="ui">
            <div>Score: <span id="score">0</span></div>
            <div>Lives: <span id="lives">3</span></div>
            <div>Coins: <span id="coins">0</span></div>
            <div>Power: <span id="power">Small</span></div>
        </div>
        
        <div class="level-info">
            <div>World: <span id="world">1</span>-<span id="level">1</span></div>
            <div>Time: <span id="time">400</span></div>
        </div>

        <div class="boss-health" id="bossHealth">
            <div>Boss Health</div>
            <div class="health-bar">
                <div class="health-fill" id="healthFill"></div>
            </div>
        </div>
        
        <div class="loading" id="loading">Loading Mario...</div>
        
        <canvas id="gameCanvas" width="1000" height="600"></canvas>
        
        <div class="controls">
            <div>ðŸŽ® Arrow Keys/WASD: Move | Space: Jump/Fire | X: Run | P: Pause | R: Restart</div>
            <div>ðŸ’° Collect coins and power-ups | ðŸ‘¾ Defeat enemies and bosses!</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const loadingEl = document.getElementById('loading');

        // Game state
        let gameRunning = false;
        let gamePaused = false;
        let score = 0;
        let lives = 3;
        let coinCount = 0;
        let currentWorld = 1;
        let currentLevel = 1;
        let timeLeft = 400;
        let camera = { x: 0, y: 0 };
        let levelWidth = 3000;

        // Mario sprite and power states
        let marioSprite = null;
        let spriteLoaded = false;

        // Load the uploaded Mario sprite
        async function loadMarioSprite() {
            try {
                const imageData = await window.fs.readFile('image.png');
                const blob = new Blob([imageData], { type: 'image/png' });
                const imageUrl = URL.createObjectURL(blob);
                
                marioSprite = new Image();
                marioSprite.onload = () => {
                    spriteLoaded = true;
                    loadingEl.style.display = 'none';
                    gameRunning = true;
                    startTimer();
                    gameLoop();
                };
                marioSprite.onerror = () => {
                    createFallbackSprite();
                };
                marioSprite.src = imageUrl;
            } catch (error) {
                createFallbackSprite();
            }
        }

        function createFallbackSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const ctx = canvas.getContext('2d');
            
            // Draw pixel Mario
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(8, 4, 16, 8);
            ctx.fillStyle = '#FFDBAC';
            ctx.fillRect(8, 12, 16, 8);
            ctx.fillStyle = '#000000';
            ctx.fillRect(10, 14, 2, 2);
            ctx.fillRect(20, 14, 2, 2);
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(12, 18, 8, 2);
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(6, 20, 20, 6);
            ctx.fillStyle = '#0000FF';
            ctx.fillRect(8, 26, 16, 6);
            
            marioSprite = canvas;
            spriteLoaded = true;
            loadingEl.style.display = 'none';
            gameRunning = true;
            startTimer();
            gameLoop();
        }

        // Player object
        const player = {
            x: 100,
            y: 400,
            width: 32,
            height: 32,
            velX: 0,
            velY: 0,
            speed: 4,
            maxSpeed: 8,
            jumpPower: 16,
            grounded: false,
            facing: 1,
            animFrame: 0,
            animTimer: 0,
            isRunning: false,
            powerState: 'small', // small, super, fire
            invulnerable: false,
            invulnerabilityTimer: 0,
            fireballs: []
        };

        // Input handling
        const keys = {};
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            if (e.key.toLowerCase() === 'p') {
                gamePaused = !gamePaused;
            }
            // Restart game when it's over
            if (!gameRunning && (e.key === 'F5' || e.key.toLowerCase() === 'r')) {
                e.preventDefault();
                restartGame();
            }
        });
        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        // Level data
        const levels = {
            '1-1': {
                background: '#5C94FC',
                platforms: [
                    {x: 0, y: 550, width: 3000, height: 50, color: '#8B4513', type: 'ground'},
                    {x: 300, y: 450, width: 200, height: 20, color: '#228B22', type: 'platform'},
                    {x: 600, y: 350, width: 150, height: 20, color: '#228B22', type: 'platform'},
                    {x: 900, y: 250, width: 180, height: 20, color: '#228B22', type: 'platform'},
                    {x: 1300, y: 150, width: 150, height: 20, color: '#228B22', type: 'platform'},
                    {x: 1600, y: 400, width: 120, height: 20, color: '#228B22', type: 'platform'},
                    {x: 2000, y: 300, width: 200, height: 20, color: '#228B22', type: 'platform'},
                    {x: 2400, y: 200, width: 150, height: 20, color: '#228B22', type: 'platform'}
                ],
                enemies: [
                    {x: 400, y: 510, type: 'goomba'},
                    {x: 700, y: 310, type: 'koopa'},
                    {x: 1100, y: 510, type: 'goomba'},
                    {x: 1500, y: 360, type: 'koopa'},
                    {x: 1800, y: 510, type: 'piranha'},
                    {x: 2200, y: 260, type: 'goomba'}
                ],
                coins: [
                    {x: 350, y: 400}, {x: 650, y: 300}, {x: 950, y: 200}, {x: 1350, y: 100},
                    {x: 500, y: 500}, {x: 800, y: 500}, {x: 1200, y: 500}, {x: 1700, y: 350},
                    {x: 2050, y: 250}, {x: 2450, y: 150}
                ],
                powerUps: [
                    {x: 1000, y: 200, type: 'mushroom'},
                    {x: 2100, y: 250, type: 'fireFlower'}
                ]
            },
            '1-2': {
                background: '#2F4F4F',
                platforms: [
                    {x: 0, y: 550, width: 3500, height: 50, color: '#696969', type: 'ground'},
                    {x: 200, y: 450, width: 100, height: 20, color: '#A0522D', type: 'platform'},
                    {x: 400, y: 350, width: 150, height: 20, color: '#A0522D', type: 'platform'},
                    {x: 700, y: 250, width: 200, height: 20, color: '#A0522D', type: 'platform'},
                    {x: 1100, y: 400, width: 100, height: 20, color: '#A0522D', type: 'platform'},
                    {x: 1400, y: 300, width: 180, height: 20, color: '#A0522D', type: 'platform'},
                    {x: 1800, y: 200, width: 150, height: 20, color: '#A0522D', type: 'platform'},
                    {x: 2200, y: 350, width: 200, height: 20, color: '#A0522D', type: 'platform'},
                    {x: 2600, y: 150, width: 120, height: 20, color: '#A0522D', type: 'platform'},
                    {x: 3000, y: 400, width: 300, height: 20, color: '#A0522D', type: 'platform'}
                ],
                enemies: [
                    {x: 300, y: 510, type: 'koopa'},
                    {x: 500, y: 310, type: 'buzzy'},
                    {x: 800, y: 210, type: 'koopa'},
                    {x: 1200, y: 360, type: 'buzzy'},
                    {x: 1500, y: 260, type: 'goomba'},
                    {x: 1900, y: 160, type: 'koopa'},
                    {x: 2300, y: 310, type: 'buzzy'},
                    {x: 2700, y: 110, type: 'goomba'},
                    {x: 3100, y: 360, type: 'koopa'}
                ],
                coins: [
                    {x: 250, y: 400}, {x: 450, y: 300}, {x: 750, y: 200}, {x: 1150, y: 350},
                    {x: 1450, y: 250}, {x: 1850, y: 150}, {x: 2250, y: 300}, {x: 2650, y: 100},
                    {x: 600, y: 500}, {x: 1000, y: 500}, {x: 1600, y: 500}, {x: 2000, y: 500}
                ],
                powerUps: [
                    {x: 800, y: 200, type: 'mushroom'},
                    {x: 1500, y: 250, type: 'fireFlower'},
                    {x: 2300, y: 300, type: '1up'}
                ]
            },
            '1-3': { // Boss Level
                background: '#8B0000',
                platforms: [
                    {x: 0, y: 550, width: 2000, height: 50, color: '#2F2F2F', type: 'ground'},
                    {x: 300, y: 400, width: 100, height: 20, color: '#A0522D', type: 'platform'},
                    {x: 600, y: 300, width: 100, height: 20, color: '#A0522D', type: 'platform'},
                    {x: 900, y: 200, width: 100, height: 20, color: '#A0522D', type: 'platform'},
                    {x: 1200, y: 300, width: 100, height: 20, color: '#A0522D', type: 'platform'},
                    {x: 1500, y: 400, width: 100, height: 20, color: '#A0522D', type: 'platform'}
                ],
                enemies: [
                    {x: 1600, y: 450, type: 'bowser', health: 10}
                ],
                coins: [
                    {x: 350, y: 350}, {x: 650, y: 250}, {x: 950, y: 150}, {x: 1250, y: 250}, {x: 1550, y: 350}
                ],
                powerUps: [
                    {x: 200, y: 500, type: 'fireFlower'},
                    {x: 1000, y: 150, type: '1up'}
                ]
            }
        };

        let currentLevelData = levels['1-1'];
        let platforms = [...currentLevelData.platforms];
        let enemies = [];
        let coins = [];
        let powerUps = [];
        let fireballs = [];
        let boss = null;

        function initializeLevel() {
            platforms = [...currentLevelData.platforms];
            enemies = [];
            coins = [];
            powerUps = [];
            fireballs = [];
            boss = null;

            // Initialize enemies
            currentLevelData.enemies.forEach(enemyData => {
                const enemy = {
                    x: enemyData.x,
                    y: enemyData.y,
                    width: enemyData.type === 'bowser' ? 80 : 30,
                    height: enemyData.type === 'bowser' ? 80 : 30,
                    velX: enemyData.type === 'buzzy' ? -0.5 : (enemyData.type === 'bowser' ? 0 : -1),
                    type: enemyData.type,
                    alive: true,
                    animFrame: 0,
                    animTimer: 0,
                    health: enemyData.health || 1,
                    maxHealth: enemyData.health || 1,
                    attackTimer: 0,
                    direction: -1
                };

                if (enemyData.type === 'bowser') {
                    boss = enemy;
                    document.getElementById('bossHealth').style.display = 'block';
                }

                enemies.push(enemy);
            });

            // Initialize coins
            currentLevelData.coins.forEach(coinData => {
                coins.push({
                    x: coinData.x,
                    y: coinData.y,
                    width: 20,
                    height: 20,
                    collected: false,
                    animFrame: 0
                });
            });

            // Initialize power-ups
            currentLevelData.powerUps.forEach(powerData => {
                powerUps.push({
                    x: powerData.x,
                    y: powerData.y,
                    width: 32,
                    height: 32,
                    type: powerData.type,
                    collected: false,
                    velX: 1,
                    velY: 0
                });
            });

            // Reset player position
            player.x = 100;
            player.y = 400;
            player.velX = 0;
            player.velY = 0;
            camera.x = 0;
        }

        function startTimer() {
            setInterval(() => {
                if (gameRunning && !gamePaused && timeLeft > 0) {
                    timeLeft--;
                    if (timeLeft <= 0) {
                        lives--;
                        if (lives > 0) {
                            timeLeft = 400;
                            respawnPlayer();
                        } else {
                            gameOver();
                        }
                    }
                }
            }, 1000);
        }

        function updatePlayer() {
            if (player.invulnerable) {
                player.invulnerabilityTimer--;
                if (player.invulnerabilityTimer <= 0) {
                    player.invulnerable = false;
                }
            }

            // Horizontal movement
            let acceleration = 0.5;
            let maxSpeed = player.speed;
            
            if (keys['x'] || keys['shift']) {
                maxSpeed = player.maxSpeed;
                player.isRunning = true;
            } else {
                player.isRunning = false;
            }

            if (keys['a'] || keys['arrowleft']) {
                player.velX -= acceleration;
                player.facing = -1;
            } else if (keys['d'] || keys['arrowright']) {
                player.velX += acceleration;
                player.facing = 1;
            } else {
                player.velX *= 0.85;
            }

            if (player.velX > maxSpeed) player.velX = maxSpeed;
            if (player.velX < -maxSpeed) player.velX = -maxSpeed;

            // Jumping
            if ((keys['w'] || keys['arrowup'] || keys[' ']) && player.grounded) {
                player.velY = -player.jumpPower;
                player.grounded = false;
            }

            // Fireball shooting
            if (keys[' '] && player.powerState === 'fire' && player.grounded) {
                if (fireballs.length < 2) {
                    fireballs.push({
                        x: player.x + (player.facing === 1 ? player.width : 0),
                        y: player.y + player.height / 2,
                        velX: player.facing * 8,
                        velY: -3,
                        width: 8,
                        height: 8,
                        bounces: 0
                    });
                }
            }

            // Gravity
            player.velY += 0.8;
            if (player.velY > 20) player.velY = 20;

            // Update position
            player.x += player.velX;
            player.y += player.velY;

            // Animation
            if (Math.abs(player.velX) > 0.5) {
                player.animTimer++;
                if (player.animTimer > 8) {
                    player.animFrame = (player.animFrame + 1) % 3;
                    player.animTimer = 0;
                }
            } else {
                player.animFrame = 0;
            }

            // Camera follows player
            camera.x = player.x - canvas.width / 2;
            if (camera.x < 0) camera.x = 0;
            if (camera.x > levelWidth - canvas.width) camera.x = levelWidth - canvas.width;

            // Level completion
            if (player.x > levelWidth - 100) {
                nextLevel();
            }

            // Check for level completion (all coins collected in non-boss levels)
            if (currentLevel !== 3 && coins.every(coin => coin.collected)) {
                nextLevel();
            }

            // Death check
            if (player.y > canvas.height + 50) {
                playerDeath();
            }
        }

        function updateFireballs() {
            fireballs.forEach((fireball, index) => {
                fireball.x += fireball.velX;
                fireball.y += fireball.velY;
                fireball.velY += 0.3; // Gravity

                // Bounce off ground
                if (fireball.y > 520) {
                    fireball.y = 520;
                    fireball.velY = -6;
                    fireball.bounces++;
                    if (fireball.bounces > 3) {
                        fireballs.splice(index, 1);
                    }
                }

                // Remove if off screen
                if (fireball.x < camera.x - 50 || fireball.x > camera.x + canvas.width + 50) {
                    fireballs.splice(index, 1);
                }
            });
        }

        function updateEnemies() {
            enemies.forEach((enemy, index) => {
                if (!enemy.alive) return;

                enemy.animTimer++;
                if (enemy.animTimer > 30) {
                    enemy.animFrame = (enemy.animFrame + 1) % 2;
                    enemy.animTimer = 0;
                }

                if (enemy.type === 'bowser') {
                    updateBoss(enemy);
                } else if (enemy.type === 'piranha') {
                    // Piranha plants don't move
                    enemy.animFrame = Math.sin(Date.now() * 0.01) > 0 ? 1 : 0;
                } else {
                    // Regular enemy movement
                    enemy.x += enemy.velX;

                    // Check platform edges
                    let onPlatform = false;
                    platforms.forEach(platform => {
                        if (enemy.x + enemy.width/2 >= platform.x &&
                            enemy.x + enemy.width/2 <= platform.x + platform.width &&
                            enemy.y + enemy.height >= platform.y &&
                            enemy.y <= platform.y + platform.height) {
                            onPlatform = true;
                        }
                    });

                    if (!onPlatform || enemy.x <= 0 || enemy.x >= levelWidth - enemy.width) {
                        enemy.velX *= -1;
                    }
                }
            });
        }

        function updateBoss(boss) {
            boss.attackTimer++;
            
            // Move towards player
            if (boss.x > player.x) {
                boss.velX = -1;
                boss.direction = -1;
            } else {
                boss.velX = 1;
                boss.direction = 1;
            }
            
            boss.x += boss.velX;

            // Boss attacks
            if (boss.attackTimer > 120) { // Attack every 2 seconds
                // Fireball attack
                enemies.push({
                    x: boss.x + boss.width/2,
                    y: boss.y + boss.height/2,
                    width: 16,
                    height: 16,
                    velX: boss.direction * 4,
                    velY: -2,
                    type: 'fireball',
                    alive: true,
                    animFrame: 0,
                    animTimer: 0
                });
                boss.attackTimer = 0;
            }

            // Update boss health display
            const healthFill = document.getElementById('healthFill');
            healthFill.style.width = (boss.health / boss.maxHealth * 100) + '%';
        }

        function updatePowerUps() {
            powerUps.forEach(powerUp => {
                if (!powerUp.collected) {
                    powerUp.x += powerUp.velX;
                    powerUp.y += powerUp.velY;
                    powerUp.velY += 0.5; // Gravity

                    // Platform collisions for power-ups
                    platforms.forEach(platform => {
                        if (powerUp.x < platform.x + platform.width &&
                            powerUp.x + powerUp.width > platform.x &&
                            powerUp.y < platform.y + platform.height &&
                            powerUp.y + powerUp.height > platform.y) {
                            
                            if (powerUp.velY > 0) {
                                powerUp.y = platform.y - powerUp.height;
                                powerUp.velY = 0;
                            }
                        }
                    });

                    // Reverse direction at edges
                    if (powerUp.x <= 0 || powerUp.x >= levelWidth - powerUp.width) {
                        powerUp.velX *= -1;
                    }
                }
            });
        }

        function checkCollisions() {
            player.grounded = false;

            // Platform collisions
            platforms.forEach(platform => {
                if (player.x < platform.x + platform.width &&
                    player.x + player.width > platform.x &&
                    player.y < platform.y + platform.height &&
                    player.y + player.height > platform.y) {
                    
                    if (player.velY > 0 && player.y < platform.y) {
                        player.y = platform.y - player.height;
                        player.velY = 0;
                        player.grounded = true;
                    } else if (player.velY < 0 && player.y > platform.y) {
                        player.y = platform.y + platform.height;
                        player.velY = 0;
                    } else if (player.velX > 0) {
                        player.x = platform.x - player.width;
                        player.velX = 0;
                    } else if (player.velX < 0) {
                        player.x = platform.x + platform.width;
                        player.velX = 0;
                    }
                }
            });

            // Coin collisions
            coins.forEach(coin => {
                if (!coin.collected &&
                    player.x < coin.x + coin.width &&
                    player.x + player.width > coin.x &&
                    player.y < coin.y + coin.height &&
                    player.y + player.height > coin.y) {
                    
                    coin.collected = true;
                    coinCount++;
                    score += 200;
                    
                    if (coinCount % 100 === 0) {
                        lives++;
                    }
                }
            });

            // Power-up collisions
            powerUps.forEach(powerUp => {
                if (!powerUp.collected &&
                    player.x < powerUp.x + powerUp.width &&
                    player.x + player.width > powerUp.x &&
                    player.y < powerUp.y + powerUp.height &&
                    player.y + powerUp.height > powerUp.y) {
                    
                    powerUp.collected = true;
                    score += 1000;
                    
                    if (powerUp.type === 'mushroom') {
                        if (player.powerState === 'small') {
                            player.powerState = 'super';
                            player.height = 48;
                        }
                    } else if (powerUp.type === 'fireFlower') {
                        player.powerState = 'fire';
                        player.height = 48;
                    } else if (powerUp.type === '1up') {
                        lives++;
                    }
                }
            });

            // Enemy collisions
            enemies.forEach((enemy, index) => {
                if (!enemy.alive) return;

                if (player.x < enemy.x + enemy.width &&
                    player.x + player.width > enemy.x &&
                    player.y < enemy.y + enemy.height &&
                    player.y + player.height > enemy.y) {
                    
                    if (enemy.type === 'fireball') {
                        playerHit();
                        enemy.alive = false;
                    } else if (player.velY > 0 && player.y < enemy.y - 5 && enemy.type !== 'piranha') {
                        // Player jumping on enemy
                        enemy.alive = false;
                        player.velY = -10;
                        score += enemy.type === 'bowser' ? 5000 : 400;
                        
                        if (enemy.type === 'bowser') {
                            enemy.health--;
                            if (enemy.health <= 0) {
                                enemy.alive = false;
                                score += 10000;
                                document.getElementById('bossHealth').style.display = 'none';
                                setTimeout(() => nextLevel(), 1000);
                            } else {
                                enemy.alive = true; // Boss doesn't die from one hit
                            }
                        }
                    } else if (!player.invulnerable) {
                        playerHit();
                    }
                }
            });

            // Fireball-enemy collisions
            fireballs.forEach((fireball, fIndex) => {
                enemies.forEach((enemy, eIndex) => {
                    if (enemy.alive && enemy.type !== 'fireball' &&
                        fireball.x < enemy.x + enemy.width &&
                        fireball.x + fireball.width > enemy.x &&
                        fireball.y < enemy.y + enemy.height &&
                        fireball.y + fireball.height > enemy.y) {
                        
                        fireballs.splice(fIndex, 1);
                        if (enemy.type === 'bowser') {
                            enemy.health--;
                            if (enemy.health <= 0) {
                                enemy.alive = false;
                                score += 10000;
                                document.getElementById('bossHealth').style.display = 'none';
                                setTimeout(() => nextLevel(), 1000);
                            }
                        } else {
                            enemy.alive = false;
                            score += 500;
                        }
                    }
                });
            });
        }

        function playerHit() {
            if (player.powerState === 'fire' || player.powerState === 'super') {
                player.powerState = 'small';
                player.height = 32;
                player.invulnerable = true;
                player.invulnerabilityTimer = 120;
            } else {
                playerDeath();
            }
        }

        function playerDeath() {
            lives--;
            if (lives > 0) {
                respawnPlayer();
            } else {
                gameOver();
            }
        }

        function respawnPlayer() {
            player.x = 100;
            player.y = 400;
            player.velX = 0;
            player.velY = 0;
            player.powerState = 'small';
            player.height = 32;
            player.invulnerable = true;
            player.invulnerabilityTimer = 120;
            camera.x = 0;
            timeLeft = 400;
            
            // Clear any fireballs
            fireballs = [];
        }

        function restartGame() {
            // Reset all game state
            gameRunning = true;
            gamePaused = false;
            score = 0;
            lives = 3;
            coinCount = 0;
            currentWorld = 1;
            currentLevel = 1;
            timeLeft = 400;
            camera = { x: 0, y: 0 };
            
            // Reset player
            player.x = 100;
            player.y = 400;
            player.velX = 0;
            player.velY = 0;
            player.powerState = 'small';
            player.height = 32;
            player.invulnerable = false;
            player.invulnerabilityTimer = 0;
            player.facing = 1;
            player.animFrame = 0;
            player.animTimer = 0;
            player.isRunning = false;
            player.fireballs = [];
            
            // Reset level
            currentLevelData = levels['1-1'];
            boss = null;
            document.getElementById('bossHealth').style.display = 'none';
            
            // Initialize level
            initializeLevel();
        }

        function nextLevel() {
            if (currentLevel === 3) {
                // Next world
                currentWorld++;
                currentLevel = 1;
                if (currentWorld > 1) {
                    // Game completed
                    gameRunning = false;
                    return;
                }
            } else {
                currentLevel++;
            }

            const levelKey = currentWorld + '-' + currentLevel;
            if (levels[levelKey]) {
                currentLevelData = levels[levelKey];
                initializeLevel();
                timeLeft = 400;
                score += timeLeft * 10; // Bonus for remaining time
            } else {
                gameRunning = false;
            }
        }

        function drawPlayer() {
            if (player.invulnerable && Math.floor(player.invulnerabilityTimer / 5) % 2) {
                return; // Flashing effect when invulnerable
            }

            ctx.save();
            
            // Color tint based on power state
            if (player.powerState === 'fire') {
                ctx.fillStyle = 'rgba(255, 200, 200, 0.3)';
                ctx.fillRect(player.x - camera.x, player.y - camera.y, player.width, player.height);
            }
            
            if (player.facing === -1) {
                ctx.scale(-1, 1);
                ctx.drawImage(
                    marioSprite,
                    -(player.x - camera.x + player.width),
                    player.y - camera.y,
                    player.width,
                    player.height
                );
            } else {
                ctx.drawImage(
                    marioSprite,
                    player.x - camera.x,
                    player.y - camera.y,
                    player.width,
                    player.height
                );
            }
            
            ctx.restore();
        }

        function drawEnemies() {
            enemies.forEach(enemy => {
                if (!enemy.alive) return;

                const x = enemy.x - camera.x;
                const y = enemy.y - camera.y;

                switch (enemy.type) {
                    case 'goomba':
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(x, y, enemy.width, enemy.height);
                        ctx.fillStyle = '#000';
                        ctx.fillRect(x + 5, y + 5, 4, 4);
                        ctx.fillRect(x + 20, y + 5, 4, 4);
                        break;
                    case 'koopa':
                        ctx.fillStyle = '#228B22';
                        ctx.fillRect(x, y, enemy.width, enemy.height);
                        ctx.fillStyle = '#FFFF00';
                        ctx.fillRect(x + 5, y + 10, enemy.width - 10, enemy.height - 15);
                        break;
                    case 'buzzy':
                        ctx.fillStyle = '#2F2F2F';
                        ctx.fillRect(x, y, enemy.width, enemy.height);
                        ctx.fillStyle = '#FFD700';
                        ctx.fillRect(x + 5, y + 5, 4, 4);
                        ctx.fillRect(x + 20, y + 5, 4, 4);
                        break;
                    case 'piranha':
                        ctx.fillStyle = '#FF0000';
                        ctx.fillRect(x, y, enemy.width, enemy.height);
                        ctx.fillStyle = '#FFFFFF';
                        for (let i = 0; i < 5; i++) {
                            ctx.fillRect(x + i * 5, y + 10, 3, 6);
                        }
                        break;
                    case 'bowser':
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(x, y, enemy.width, enemy.height);
                        ctx.fillStyle = '#FF0000';
                        ctx.fillRect(x + 10, y + 10, enemy.width - 20, 20);
                        ctx.fillStyle = '#FFFF00';
                        ctx.fillRect(x + 15, y + 15, 10, 10);
                        ctx.fillRect(x + 55, y + 15, 10, 10);
                        // Horns
                        ctx.fillStyle = '#FFF';
                        ctx.fillRect(x + 5, y, 8, 15);
                        ctx.fillRect(x + 67, y, 8, 15);
                        break;
                    case 'fireball':
                        ctx.fillStyle = '#FF4500';
                        ctx.beginPath();
                        ctx.arc(x + enemy.width/2, y + enemy.height/2, enemy.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        break;
                }
            });
        }

        function drawFireballs() {
            fireballs.forEach(fireball => {
                ctx.fillStyle = '#FF6600';
                ctx.beginPath();
                ctx.arc(
                    fireball.x - camera.x + fireball.width/2,
                    fireball.y - camera.y + fireball.height/2,
                    fireball.width/2,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
            });
        }

        function drawPlatforms() {
            platforms.forEach(platform => {
                ctx.fillStyle = platform.color;
                ctx.fillRect(
                    platform.x - camera.x,
                    platform.y - camera.y,
                    platform.width,
                    platform.height
                );
                
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.fillRect(
                    platform.x - camera.x,
                    platform.y - camera.y,
                    platform.width,
                    3
                );
            });
        }

        function drawCoins() {
            coins.forEach(coin => {
                if (!coin.collected) {
                    coin.animFrame += 0.2;
                    
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(
                        coin.x + coin.width/2 - camera.x,
                        coin.y + coin.height/2 - camera.y,
                        coin.width/2 * (0.8 + 0.2 * Math.sin(coin.animFrame)),
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                }
            });
        }

        function drawPowerUps() {
            powerUps.forEach(powerUp => {
                if (!powerUp.collected) {
                    const x = powerUp.x - camera.x;
                    const y = powerUp.y - camera.y;

                    switch (powerUp.type) {
                        case 'mushroom':
                            ctx.fillStyle = '#FF0000';
                            ctx.fillRect(x, y, powerUp.width, powerUp.height/2);
                            ctx.fillStyle = '#FFFFFF';
                            for (let i = 0; i < 3; i++) {
                                ctx.fillRect(x + i * 8 + 4, y + 4, 4, 4);
                            }
                            ctx.fillStyle = '#FFDBAC';
                            ctx.fillRect(x, y + powerUp.height/2, powerUp.width, powerUp.height/2);
                            break;
                        case 'fireFlower':
                            ctx.fillStyle = '#FF4500';
                            ctx.fillRect(x + 8, y + 8, 16, 16);
                            ctx.fillStyle = '#FFFF00';
                            ctx.fillRect(x + 12, y + 12, 8, 8);
                            ctx.fillStyle = '#228B22';
                            ctx.fillRect(x + 14, y + 20, 4, 12);
                            break;
                        case '1up':
                            ctx.fillStyle = '#00FF00';
                            ctx.fillRect(x, y, powerUp.width, powerUp.height/2);
                            ctx.fillStyle = '#FFFFFF';
                            for (let i = 0; i < 3; i++) {
                                ctx.fillRect(x + i * 8 + 4, y + 4, 4, 4);
                            }
                            ctx.fillStyle = '#FFDBAC';
                            ctx.fillRect(x, y + powerUp.height/2, powerUp.width, powerUp.height/2);
                            break;
                    }
                }
            });
        }

        function drawBackground() {
            // Set background based on level
            canvas.style.background = `linear-gradient(to bottom, ${currentLevelData.background}, #98FB98)`;
            
            // Clouds (only in outdoor levels)
            if (currentLevelData.background === '#5C94FC') {
                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                for (let i = 0; i < 5; i++) {
                    let cloudX = 200 + i * 400 - camera.x * 0.3;
                    let cloudY = 80 + Math.sin(i) * 30;
                    
                    ctx.beginPath();
                    ctx.arc(cloudX, cloudY, 25, 0, Math.PI * 2);
                    ctx.arc(cloudX + 25, cloudY, 35, 0, Math.PI * 2);
                    ctx.arc(cloudX + 50, cloudY, 25, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('lives').textContent = lives;
            document.getElementById('coins').textContent = coinCount;
            document.getElementById('world').textContent = currentWorld;
            document.getElementById('level').textContent = currentLevel;
            document.getElementById('time').textContent = timeLeft;
            document.getElementById('power').textContent = 
                player.powerState === 'small' ? 'Small' :
                player.powerState === 'super' ? 'Super' : 'Fire';
        }

        function gameOver() {
            gameRunning = false;
        }

        function drawGameOver() {
            // Dark overlay
            ctx.fillStyle = 'rgba(0,0,0,0.9)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Red border for dramatic effect
            ctx.strokeStyle = '#FF0000';
            ctx.lineWidth = 8;
            ctx.strokeRect(50, 150, canvas.width - 100, canvas.height - 300);
            
            // Main title
            ctx.fillStyle = '#FF0000';
            ctx.font = 'bold 60px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('GAME OVER', canvas.width/2, canvas.height/2 - 50);
            
            // Text shadow for main title
            ctx.fillStyle = '#000';
            ctx.fillText('GAME OVER', canvas.width/2 + 3, canvas.height/2 - 47);
            ctx.fillStyle = '#FF0000';
            ctx.fillText('GAME OVER', canvas.width/2, canvas.height/2 - 50);
            
            // Score display
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 28px Arial';
            ctx.fillText('Final Score: ' + score, canvas.width/2, canvas.height/2 + 10);
            
            // World/Level display
            ctx.font = '22px Arial';
            ctx.fillText('World ' + currentWorld + '-' + currentLevel, canvas.width/2, canvas.height/2 + 45);
            
            // Restart instruction
            ctx.fillStyle = '#FFFF00';
            ctx.font = 'bold 24px Arial';
            ctx.fillText('Press R to restart', canvas.width/2, canvas.height/2 + 90);
            
            // Flashing effect for restart text
            if (Math.floor(Date.now() / 500) % 2) {
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText('Press R to restart', canvas.width/2, canvas.height/2 + 90);
            }
        }

        function gameWin() {
            gameRunning = false;
        }

        function drawGameWin() {
            // Golden overlay
            ctx.fillStyle = 'rgba(255,215,0,0.9)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Golden border
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 8;
            ctx.strokeRect(50, 100, canvas.width - 100, canvas.height - 200);
            
            // Fireworks effect
            for (let i = 0; i < 20; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 5 + 2;
                ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 50%)`;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Main title
            ctx.fillStyle = '#FF0000';
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('CONGRATULATIONS!', canvas.width/2, canvas.height/2 - 80);
            
            // Text shadow
            ctx.fillStyle = '#000';
            ctx.fillText('CONGRATULATIONS!', canvas.width/2 + 2, canvas.height/2 - 78);
            ctx.fillStyle = '#FF0000';
            ctx.fillText('CONGRATULATIONS!', canvas.width/2, canvas.height/2 - 80);
            
            // Success message
            ctx.fillStyle = '#000';
            ctx.font = 'bold 32px Arial';
            ctx.fillText('You Saved The Princess!', canvas.width/2, canvas.height/2 - 30);
            
            // Princess icon
            ctx.fillStyle = '#FFB6C1';
            ctx.font = '40px Arial';
            ctx.fillText('ðŸ‘¸', canvas.width/2, canvas.height/2 + 20);
            
            // Score display
            ctx.fillStyle = '#000';
            ctx.font = 'bold 28px Arial';
            ctx.fillText('Final Score: ' + score, canvas.width/2, canvas.height/2 + 60);
            
            // Restart instruction
            ctx.fillStyle = '#8B0000';
            ctx.font = 'bold 24px Arial';
            ctx.fillText('Press R to play again', canvas.width/2, canvas.height/2 + 100);
            
            // Flashing effect
            if (Math.floor(Date.now() / 500) % 2) {
                ctx.fillStyle = '#FF0000';
                ctx.fillText('Press R to play again', canvas.width/2, canvas.height/2 + 100);
            }
        }

        function gameLoop() {
            if (gamePaused) {
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#FFF';
                ctx.font = '36px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('PAUSED', canvas.width/2, canvas.height/2);
                ctx.font = '18px Arial';
                ctx.fillText('Press P to resume', canvas.width/2, canvas.height/2 + 40);
                requestAnimationFrame(gameLoop);
                return;
            }

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (gameRunning) {
                // Update game state
                updatePlayer();
                updateEnemies();
                updatePowerUps();
                updateFireballs();
                checkCollisions();

                // Draw game elements
                drawBackground();
                drawPlatforms();
                drawCoins();
                drawPowerUps();
                drawEnemies();
                drawFireballs();
                if (spriteLoaded) {
                    drawPlayer();
                }

                updateUI();
            } else {
                // Game is over - determine if won or lost
                const allCoinsCollected = coins.every(coin => coin.collected);
                const bossDefeated = boss && !boss.alive;
                
                if ((allCoinsCollected || bossDefeated) && lives > 0) {
                    drawGameWin();
                } else {
                    drawGameOver();
                }
            }

            requestAnimationFrame(gameLoop);
        }

        // Initialize the game
        initializeLevel();
        loadMarioSprite();
    </script>
</body>
</html>
